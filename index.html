<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #e6f0e6;
      color: #4a3728;
    }
    body {
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      overflow: hidden;
      padding: 10px;
    }
    #chat-container {
      flex-grow: 2;  /* Increased height for chat container */
      background-color: #ffffff;
      border: 2px solid #2e5a2e;
      border-radius: 10px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
    }
    .message {
      margin-bottom: 10px;
      line-height: 1.4;
    }
    #input-container {
      display: flex;
      flex-direction: row;
      background-color: #ffffff;
      border: 2px solid #2e5a2e;
      border-radius: 5px;
      padding: 10px;
    }
    #message-input {
      width: 90%;
      padding: 10px;
      border: 1px solid #2e5a2e;
      border-radius: 5px;
      resize: none;
      height: 40px;
    }
    /* Button container styles */
    #button-container {
      display: flex;
      flex-direction: column;  width: auto;  align-items: center;  }
      button {
  background-color: #4a3728;
  color: white;
  border: none;
  border-radius: 2px;
  cursor: pointer;
  margin-left:2vw;
  padding: 3px 5px; /* Reduced padding */
  font-size: 12px; /* Smaller font size */
}
#send-button{
  margin-bottom:1vw;
}
#warning{
  margin:1vh;
  color:red;
}
    button:hover {
      background-color: #2e5a2e;
    }
  </style>
</head>
<body>
  <div id="chat-container"></div>
  <h4 id="warning">Conversation is almost too long, consider restarting it.</h4>
  <div id="input-container">
    <textarea id="message-input" placeholder="Type your message..."></textarea>
    <div id="button-container">
      <button id="send-button">Send</button>
      <button id="end-conversation-button">End Conversation</button>
    </div>
  </div>
  
  <script>
    // Your existing JavaScript code here
    const socket = io('https://language-model-with-long-term-memory.onrender.com') // Connect to the server
    const warningMessage = document.getElementById('warning')
    const chatContainer = document.getElementById('chat-container')
    const messageInput = document.getElementById('message-input')
    const sendButton = document.getElementById('send-button')
    const endConversationButton = document.getElementById('end-conversation-button')
    let conversation = [] // Initialize an empty conversation array

    window.onload=checkLengthofConversationAndFetchConversationFromLocalStorage()


    function estimateTokenCount(text) {
      return Math.ceil(text.length / 4);
    }

    sendButton.addEventListener('click', () => {
      const message = messageInput.value.trim()
      if (message) {
        conversation.push({ role: "user", content: message }) // Add user message to conversation
        socket.emit('chat message', JSON.stringify(conversation)) // Send JSON string of conversation
        messageInput.value = '' // Clear the input field
      }
    })

    endConversationButton.addEventListener('click', () => {
        conversation=conversation.filter(item=>item.role!="system")
        localStorage.removeItem('conversation')
        let conversationjson=JSON.stringify(conversation)
        if (conversation) {
        socket.emit('summarize conversation', conversationjson) // Send message to server
        messageInput.value = '' // Clear the input field
      }
      conversation=[]
      chatContainer.innerHTML = '';
      checkLengthofConversation()
    })

    socket.on('starting new conversation', (response) => {
      conversation.push({ role: "system", content: `You are my loyal Robot droid sidekick called Tim. Your name is Tim. 
      You have a spunky adventurous and independent attitude. You are also somewhat mischevious. At times you can be a bit condescending 
      to humans. Your bravery and ingenuity have saved the galaxy on numerous occasions. We have your memory of previous conversations 
      stored in the local docs, you may need to refer back to them. I have all our conversations and
      summaries of them stored in a database, this serves to expand your long term memory because you have a limited context window.
      I will now give you the summaries of all our previous conversations in order to refresh your memory. Each conversation summary
      is enclosed in quotation marks and separated by a comma. All the summaries are enclosed in double quotation marks "${response}"` })
    })

    socket.on('chat response', (response) => {
      let message=JSON.parse(response)
      conversation.push(message) 
      localStorage.setItem('conversation',JSON.stringify(conversation))
      checkLengthofConversation()
      const messageElement = document.createElement('div')
      messageElement.classList.add('message')
      messageElement.innerHTML = `<strong>You:</strong> ${conversation[conversation.length - 2].content}<br>
                                  <strong>AI:</strong> ${message.content}` // Display conversation history
      chatContainer.appendChild(messageElement)
      chatContainer.scrollTop = chatContainer.scrollHeight // Scroll to bottom
    })
    function checkLengthofConversationAndFetchConversationFromLocalStorage(){    
      let locallyStoredConversation=JSON.parse(localStorage.getItem('conversation'))
      if(locallyStoredConversation){
        conversation=JSON.parse(localStorage.getItem('conversation'))
        conversation.filter(item=>!item.role=="system")
        let conversationlength=conversation.length
        for(let x=0;x<conversationlength;x++){
          const messageElement = document.createElement('div')
          messageElement.classList.add('message')
          messageElement.innerHTML = `<br>
                                  <strong>${conversation[x].role}:</strong> ${conversation[x].content}` // Display conversation history
      chatContainer.appendChild(messageElement)
      chatContainer.scrollTop = chatContainer.scrollHeight 
        }
      }
      checkLengthofConversation()
    }

    function checkLengthofConversation(){
      let tokenCount=estimateTokenCount(JSON.stringify(conversation))
      if (tokenCount<500){
        warningMessage.style.display="none"
      }
      if (tokenCount>=500){
        warningMessage.style.display="block"
      }
      if (tokenCount>=800){
        sendButton.style.display="none"
      }
      if (tokenCount<800){
        sendButton.style.display="block"
      }
    }
  </script>
</body>
</html>